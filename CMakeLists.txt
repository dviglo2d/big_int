# –£–∫–∞–∑—ã–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é CMake
cmake_minimum_required(VERSION 3.16)

# –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
project(dv_big_int)

option(DV_BIG_INT_BUILD_TESTER "–ö–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å –¢–µ—Å—Ç–µ—Ä" OFF)
option(DV_BIG_INT_UB_SANITIZER "–î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å undefined behavior" OFF)

# –í–µ—Ä—Å–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞ C++
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–¥–Ω–æ–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞
if(NOT CMAKE_CONFIGURATION_TYPES AND NOT CMAKE_BUILD_TYPE)
    # —Ç–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±—É–¥–µ—Ç Release
    set(CMAKE_BUILD_TYPE Release)
    # –ù–µ–ª—å–∑—è –æ—Å—Ç–∞–≤–ª—è—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é CMAKE_BUILD_TYPE –ø—É—Å—Ç–æ–π (–ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ Dviglo2D)
endif()

# –£–∫–∞–∑—ã–≤–∞–µ–º –°—Ç—É–¥–∏–∏ –Ω–∞ —Ç–æ, —á—Ç–æ –∏—Å—Ö–æ–¥–Ω–∏–∫–∏ –≤ –∫–æ–¥–∏—Ä–æ–≤–∫–µ UTF-8.
# –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–∏—Å–∞—Ç—å U'üçå'. –£ –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–æ–≤, –ø–æ—Ö–æ–∂–µ, –Ω–µ—Ç —Å —ç—Ç–∏–º –ø—Ä–æ–±–ª–µ–º
# https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2022/p2295r6.pdf
if(MSVC)
    add_compile_options(/utf-8)
endif()

# –í–∫–ª—é—á–∞–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø–∞–ø–æ–∫ –≤ IDE
set_property(GLOBAL PROPERTY USE_FOLDERS ON)

# ============================================== –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ ==============================================

# –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–≥–µ—Ç–∞
set(target_name dv_big_int)

# –°–æ–∑–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
file(GLOB source_files lib/*)

# –°–æ–∑–¥–∞—ë–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É
add_library(${target_name} STATIC ${source_files})

# –î–µ–ª–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º
target_include_directories(${target_name} PUBLIC lib)

# –í—ã–≤–æ–¥–∏–º –±–æ–ª—å—à–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
if(MSVC)
    target_compile_options(${target_name} PRIVATE /W4)
else() # GCC, Clang –∏–ª–∏ MinGW
    target_compile_options(${target_name} PRIVATE -Wall -Wextra -Wpedantic)

    if(NOT MINGW AND DV_BIG_INT_UB_SANITIZER)
        target_compile_options(${target_name} PRIVATE -fsanitize=undefined)
        target_link_options(${target_name} INTERFACE -fsanitize=undefined)
    endif()
endif()

# –ó–∞—Å—Ç–∞–≤–ª—è–µ–º VS –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –¥–µ—Ä–µ–≤–æ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
source_group(TREE ${CMAKE_CURRENT_SOURCE_DIR}/lib FILES ${source_files})

# ============================================== –¢–µ—Å—Ç–µ—Ä ==============================================

if(DV_BIG_INT_BUILD_TESTER)
    # –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–≥–µ—Ç–∞
    set(target_name tester)

    # –°–æ–∑–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
    file(GLOB source_files tester/*)

    # –°–æ–∑–¥–∞—ë–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    add_executable(${target_name} ${source_files})

    # –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É
    target_link_libraries(${target_name} PRIVATE dv_big_int)

    # –í—ã–≤–æ–¥–∏–º –±–æ–ª—å—à–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
    if(MSVC)
        target_compile_options(${target_name} PRIVATE /W4)
    else() # GCC, Clang –∏–ª–∏ MinGW
        target_compile_options(${target_name} PRIVATE -Wall -Wextra -Wpedantic)

        if(NOT MINGW AND DV_BIG_INT_UB_SANITIZER)
            target_compile_options(${target_name} PRIVATE -fsanitize=undefined)
        endif()
    endif()

    # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏ –ª–∏–Ω–∫—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, —á—Ç–æ–±—ã –Ω–µ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å dll-–∫–∏
    if(MINGW)
        target_link_options(${target_name} PRIVATE -static)
    endif()

    # –ó–∞—Å—Ç–∞–≤–ª—è–µ–º VS –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –¥–µ—Ä–µ–≤–æ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
    source_group(TREE ${CMAKE_CURRENT_SOURCE_DIR}/tester FILES ${source_files})

    # –í–∫–ª—é—á–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    enable_testing()

    # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫ —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã—Ö
    add_test(NAME ${target_name} COMMAND ${target_name})

    # –í Visual Studio —Ç–∞—Ä–≥–µ—Ç –±—É–¥–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω —Å—Ç–∞—Ä—Ç–æ–≤—ã–º –≤–º–µ—Å—Ç–æ ALL_BUILD,
    # —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –Ω–µ –¥–µ–ª–∞—Ç—å —ç—Ç–æ –≤—Ä—É—á–Ω—É—é –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    set_property(DIRECTORY ${CMAKE_SOURCE_DIR} PROPERTY VS_STARTUP_PROJECT ${target_name})
endif()
